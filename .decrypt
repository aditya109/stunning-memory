#!/bin/sh

# This decrypts all the files that are encrypted using sops
# One needs to have correct IAM role and STS token to decrypt the files

# usage: ./decrypt path pattern
# example: ./decrypt api/ prod

while read -r file ;do
	#new_file=`echo $file | sed 's/\.enc.json$//g'`
        sops -d -i --ignore-mac $1/$file
	if [ $? -eq 0 ]; then
		echo decrypting $file
		#rm $file
	else
		echo Failed to decrypt $file. Check your sts creds or pgp import
		#rm $new_file
	fi;
done < $1/.crypt

